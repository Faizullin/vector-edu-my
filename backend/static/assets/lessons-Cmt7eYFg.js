import{N as y,r as l,j as e,a as H,b as R}from"./index-BmiyAELg.js";import{a as _,s as f,b as E}from"./use-auth-js2yB0WI.js";import{a as K,c as Q,C as G,S as Y,L as k,D as J}from"./select-dropdown-BLzGuQJg.js";import{D as q,a as A}from"./delete-confirm-nice-dialog-BuUCB31W.js";import{H as U,T as W,P as X,M as Z}from"./theme-switch-_yrpSE89.js";import{S as ee}from"./search-BqZfjb3Q.js";import{c as $,u as F,a as V,D as se,C as ae}from"./use-custom-toast-CvPjYmcL.js";import{B as L,c as te}from"./createReactComponent-DAnOonP9.js";import{a as oe}from"./search-context-emn1PgDM.js";import{H as re,J as ne,K as le,L as ie,M as ce,N as de}from"./IconSun-CD0sLG3_.js";import{S as ue,a as me,I as pe,D as he}from"./DndDatatable-DmaSDS4J.js";import{z as b,F as xe,a as S,b as v,c as N,d as D,I,e as C}from"./index-vTqYkbZ5.js";import{B as ge}from"./book-open-BQfPZjUZ.js";import{P as fe}from"./plus-D9oxXjnl.js";import"./badge-BDni1Y-G.js";import"./handle-server-error-D0TgnIKM.js";const be=(r,n)=>y.show(r,n),T=$();function je({open:r,onOpenChange:n,lessonId:c}){const{showSuccessToast:p}=F(),x=_({mutationFn:i=>f({url:`/lessons/pages/${i}/`,method:"DELETE"})}),d=_({mutationFn:i=>f({url:`/lessons/pages/${i}/get-editor/`,method:"POST"})}),u=l.useMemo(()=>[T.display({id:"dragHandle",size:40}),T.accessor("id",{header:"ID",enableSorting:!1}),T.accessor("order",{header:"Order",enableSorting:!1}),T.display({id:"actions",cell:({row:i})=>e.jsx(q,{row:i,actions:{openPages:{label:"Open Editor",shortcutIcon:e.jsx(ue,{}),callback:({row:g})=>{d.mutate(g.original.id,{onSuccess(P){const z=`/resources/posts/${P.post.id}/edit-content?type=editor2&lesson_page_id=${g.original.id}`;window.open(z,"_blank")}})}}},defaultActions:{delete:{callback:({row:g})=>{y.show(A,{}).then(({result:P})=>{P&&(p({title:"Page deleted successfully",duration:2e3}),x.mutateAsync(g.original.id).then(()=>{h.query.refetch()}))})}}}})})],[]),h=V({name:"lessons",url:"/lessons/pages",columns:u,transformToApiParams(i){return{...i,lesson_id:c,page:1,page_size:100,ordering:"-order"}}}),a=_({mutationFn:i=>f({url:"/lessons/pages/",method:"POST",formData:{lesson:`${i}`}}),onSuccess:()=>{h.query.refetch()}}),[t,m]=l.useState(!1),w=_({mutationFn:({lessonId:i,dataIds:g})=>f({url:"/lessons/pages/reorder/",method:"POST",formData:{lesson_id:`${i}`,ordered_ids:g.reverse()}}),onSuccess:()=>{h.query.refetch(),m(!1)}}),[s,o]=l.useState([]),M=l.useCallback(()=>{a.mutate(c)},[a,c]),B=l.useCallback(()=>{t&&w.mutate({lessonId:c,dataIds:s.map(i=>i.id)})},[w,t,s,c]);return e.jsx("div",{className:"grid grid-cols-2 gap-2",children:e.jsx(re,{open:r,onOpenChange:n,children:e.jsxs(ne,{side:"bottom",children:[e.jsxs(le,{children:[e.jsx(ie,{children:"Lesson Page List"}),e.jsx(ce,{children:"This is the list of lesson pages."})]}),e.jsxs("div",{className:"flex-1 overflow-auto px-4 py-1 lg:flex-row lg:space-y-0 lg:space-x-12",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(se,{actions:[]}),e.jsxs(L,{className:"space-x-1",size:"sm",onClick:B,disabled:!t,children:[e.jsx(me,{size:18}),e.jsx("span",{children:"Save"})]}),e.jsxs(L,{className:"space-x-1",onClick:M,disabled:a.isPending,size:"sm",children:[e.jsx(pe,{size:18})," ",e.jsx("span",{children:"Add"})]})]}),e.jsx(oe,{className:"p-4 mx-auto max-w-[600px] max-h-[70vh] overflow-auto",children:e.jsx(he,{resource:h,onReorder:i=>{o(i),m(!0)}})})]}),e.jsx(de,{})]})})})}function ye({className:r,...n}){return e.jsx("textarea",{"data-slot":"textarea",className:te("border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",r),...n})}const Se=b.object({title:b.string().min(1,{message:"Title is required."}),description:b.string().optional(),lesson_batch:b.string().min(1,{message:"Lesson batch is required."}),is_available_on_free:b.boolean().optional(),order:b.string().optional()}),O=y.create(r=>{const n=y.useModal(),c=l.useMemo(()=>r.recordId?"edit":"create",[r.recordId]),{showSuccessToast:p,showErrorToast:x}=F(),d=K({schema:Se,apiService:Q({url:"/lessons/lessons"}),queryKey:"lessons",invalidateQueriesOnMutate:!0,initialMode:c,recordId:r.recordId||null,defaultValues:{title:"",description:""},notifications:{onSuccess:a=>{p({title:a,duration:2e3})},onError:a=>{x({title:a,duration:2e3})}},transformToForm(a,t){const m={...a};return t.action==="load"&&a.lesson_batch&&(m.lesson_batch=`${a.lesson_batch.id}`),m}}),u=E({queryKey:["lesson-batches"],queryFn:()=>f({url:"/lessons/batches/",method:"GET",query:{disablePagination:!0}})}),h=l.useMemo(()=>{var a;return(a=u.data)==null?void 0:a.map(t=>({label:t.title,value:`${t.id}`}))},[u.data]);return l.useEffect(()=>{var a,t;(a=r.defaultValues)!=null&&a.lesson_batch&&d.form.setValue("lesson_batch",`${(t=r.defaultValues.lesson_batch)==null?void 0:t.id}`)},[r.defaultValues]),e.jsx(G,{formHook:d,modal:n,displayType:"dialog",getTitle:a=>a.formMode==="edit"?"Edit Lesson":"Create Lesson",formName:"lessons-form",children:({control:a})=>e.jsx(xe,{...d.form,children:e.jsxs("div",{className:"space-y-4 p-0.5 mb-6",children:[e.jsx(S,{control:a,name:"title",render:({field:t})=>e.jsxs(v,{className:"grid grid-cols-6 items-center space-y-0 gap-x-4 gap-y-1",children:[e.jsx(N,{className:"col-span-2 text-right",children:"Title"}),e.jsx(D,{children:e.jsx(I,{placeholder:"Title",className:"col-span-4",autoComplete:"off",...t})}),e.jsx(C,{className:"col-span-4 col-start-3"})]})}),e.jsx(S,{control:a,name:"description",render:({field:t})=>e.jsxs(v,{className:"grid grid-cols-6 items-center space-y-0 gap-x-4 gap-y-1",children:[e.jsx(N,{className:"col-span-6 text-right",children:"Description"}),e.jsx(D,{children:e.jsx(ye,{placeholder:"Description",className:"col-span-6 mt-4",autoComplete:"off",...t})}),e.jsx(C,{className:"col-span-4 col-start-3"})]})}),e.jsx(S,{control:a,name:"lesson_batch",render:({field:t})=>e.jsxs(v,{className:"grid grid-cols-6 items-center space-y-0 gap-x-4 gap-y-1",children:[e.jsx(N,{className:"col-span-2 text-right",children:"Lesson Batch"}),e.jsx(Y,{defaultValue:t.value,onValueChange:t.onChange,placeholder:"Select",className:"col-span-4",items:h,isControlled:!0}),e.jsx(C,{className:"col-span-6 col-start-3"})]})}),e.jsx(S,{control:a,name:"is_available_on_free",render:({field:t})=>e.jsxs(v,{className:"grid grid-cols-6 items-center space-y-0 gap-x-4 gap-y-1",children:[e.jsx(N,{className:"col-span-2 text-right",children:"Is Available on Free"}),e.jsx(D,{children:e.jsx(ae,{className:"col-span-4",checked:t.value,onCheckedChange:t.onChange})})]})}),e.jsx(S,{control:a,name:"order",disabled:d.formMode!=="edit",render:({field:t})=>e.jsxs(v,{className:"grid grid-cols-6 items-center space-y-0 gap-x-4 gap-y-1",children:[e.jsx(N,{className:"col-span-2 text-right",children:"Order"}),e.jsx(D,{children:e.jsx(I,{placeholder:"Order",type:"number",className:"col-span-4",autoComplete:"off",...t})}),e.jsx(C,{className:"col-span-4 col-start-3"})]})})]})})})}),j=$(),ve=()=>{const[r,n]=l.useState(!1),[c,p]=l.useState(null),x=l.useCallback(u=>{p(u),n(!0)},[]),d=l.useCallback(()=>{n(!1)},[]);return{open:r,openDrawer:x,closeDrawer:d,setRecordId:p,recordId:c}};function Ne(){const r=H({from:"/_layout/lessons/lessons"}),n=l.useMemo(()=>{const{batch_id:s}=r;return s||null},[r]),c=R(),{showSuccessToast:p}=F(),x=_({mutationFn:s=>f({url:`/lessons/lessons/${s}/`,method:"DELETE"})}),d=E({queryKey:["lesson-batches",n],queryFn:()=>f({url:`/lessons/batches/${n}`,method:"GET"}),enabled:!!n}),u=ve(),h=l.useMemo(()=>[j.accessor("id",{header:"ID",meta:{filter:{type:"text",displayType:"toolbar"}},enableHiding:!1}),j.accessor("title",{header:"Title",enableSorting:!1,meta:{filter:{type:"text",displayType:"toolbar"},sizeBorderStyle:!0},cell:({row:s})=>e.jsx(k,{className:"max-w-36",children:s.getValue("title")}),enableHiding:!1}),j.accessor("lesson_batch",{header:"Lesson Batch",enableSorting:!1,cell:({row:s})=>{var o;return e.jsx(k,{className:"max-w-36",children:(o=s.original.lesson_batch)==null?void 0:o.title})},meta:{filter:{type:"select",options:[],displayType:"toolbar",query:{key:["lesson-batches"],fetchOptionsUrl:"/lessons/batches",transformResponse:s=>s.map(o=>({label:o.title,value:`${o.id}`}))}}}}),j.accessor("is_available_on_free",{header:"Is Available on Free",enableSorting:!1,cell:({row:s})=>s.getValue("is_available_on_free")?"Yes":"No",meta:{filter:{type:"select",options:[{label:"Yes",value:"true"},{label:"No",value:"false"}],displayType:"toolbar"}}}),j.accessor("order",{header:"Order",enableSorting:!0,cell:({row:s})=>s.getValue("order")?s.getValue("order"):"-"}),j.display({id:"actions",cell:({row:s})=>e.jsx(q,{row:s,actions:{openPages:{label:"Open Pages",shortcutIcon:e.jsx(ge,{}),callback:({row:o})=>{u.openDrawer(o.original.id)}}},defaultActions:{edit:{callback:({row:o})=>{y.show(O,{recordId:o.original.id,record:o.original})}},delete:{callback:({row:o})=>{y.show(A,{}).then(({result:M})=>{M&&(p({title:"Lesson deleted successfully",duration:2e3}),x.mutateAsync(o.original.id).then(()=>{m.query.refetch()}))})}}}})})],[c]),[a,t]=l.useState(!1),m=V({name:"lessons",url:"/lessons/lessons",columns:h,enabled:a,transformToApiParams(s){const o={...s};return s!=null&&s.lesson_batch&&(o.batch_id=s.lesson_batch,delete o.lesson_batch),o}});l.useEffect(()=>{n&&m.datatable.table.setColumnFilters(s=>[...s,{id:"lesson_batch",value:`${n}`}]),t(!0)},[n]);const w=l.useCallback(()=>{be(O,{defaultValues:{lesson_batch:d.data}})},[d.data]);return e.jsxs(e.Fragment,{children:[e.jsxs(U,{fixed:!0,children:[e.jsx(ee,{}),e.jsxs("div",{className:"ml-auto flex items-center space-x-4",children:[e.jsx(W,{}),e.jsx(X,{})]})]}),e.jsxs(Z,{children:[e.jsx(je,{lessonId:u.recordId,open:u.open,onOpenChange:s=>!s&&u.closeDrawer()}),e.jsx(J,{resource:m,topbar:{title:"Lesson List",subtitle:"Manage your lessons."},actions:[{id:"add",label:"Add",renderType:"panel",callback:w,shortcutIcon:e.jsx(fe,{})}]})]})]})}const Be=Ne;export{Be as component};
