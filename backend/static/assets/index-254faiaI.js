import{r as o,j as e,R as I,C as g,A as F,x as _,B as w,D as b,Q as A,G as U,E as q,H}from"./main-CUfsI3AY.js";import{M as z}from"./MainCard-D5eZyF4J.js";import{D as V}from"./DataTable-CxqS4FPA.js";import{u as S,a as L}from"./useApi-muFL2Lva.js";import{c as $,i as G,a as M,F as Q,b as J,d as E,E as N,C as K}from"./CSelect-DrjsPD9C.js";import{M as j}from"./Modal-CKnJLuZW.js";import{S as W}from"./Spinner-B_7WowvM.js";import{B as X}from"./BaseDeleteConfirmationModal-BTZuvhXW.js";import"./Card-B4mrgJ9R.js";import"./TransitionWrapper-QYPjZsTZ.js";import"./lodash-CVgaKlHN.js";import"./Table-I26n7k9G.js";import"./hasClass-CIfd7_8j.js";const O="/lms/lessons/lessons";function B({open:d,onClose:C,record:m,onSuccess:l}){const r=S(),[n,a]=o.useState(m||{}),h=!!n.id,p=n.lesson_batch?{value:n.lesson_batch.id,label:n.lesson_batch.title}:null,v={title:n.title||"",description:n.description||"",is_available_on_free:n.is_available_on_free||!1,lesson_batch:p},y=$().shape({title:M().required("Title is required"),description:M().required("Description is required"),is_available_on_free:G(),lesson_batch:$().nullable()}),D=async(u,s)=>{var i,f,x;try{const t={...u,lesson_batch:((i=u.lesson_batch)==null?void 0:i.value)||null};if(h)await r.mutate(`${O}/${n.id}/`,"PUT",t),b.success("Lesson updated!"),l==null||l();else{const c=await r.mutate(`${O}/`,"POST",t);a(c),b.success("Lesson created! Switching to update mode..."),l==null||l()}}catch(t){if(((f=t==null?void 0:t.response)==null?void 0:f.status)===400&&((x=t.response)!=null&&x.data)){const c=t.response.data;c.non_field_errors&&b.error(c.non_field_errors.join(", ")),c.message&&Object.entries(c.message).forEach(([T,R])=>{s.setFieldError(T,R)})}else b.error((t==null?void 0:t.message)||"Something went wrong.")}finally{s.setSubmitting(!1)}},k=p?[p]:[];return o.useEffect(()=>{a(m||{})},[m]),e.jsx(j,{show:d,onHide:C,size:"lg",centered:!0,children:e.jsx(Q,{enableReinitialize:!0,initialValues:v,validationSchema:y,onSubmit:D,children:({handleSubmit:u,touched:s,errors:i,setFieldValue:f,isSubmitting:x,values:t})=>e.jsxs(J,{onSubmit:u,children:[e.jsx(j.Header,{closeButton:!0,children:e.jsx(j.Title,{children:h?"Edit Lesson":"Create Lesson"})}),e.jsx(j.Body,{children:e.jsxs(I,{className:"g-3",children:[e.jsx(g,{md:12,children:e.jsxs(F,{label:"Title",children:[e.jsx(E,{name:"title",as:_.Control,type:"text",isInvalid:s.title&&!!i.title,placeholder:"Enter lesson title"}),e.jsx(N,{name:"title",component:_.Control.Feedback,type:"invalid"})]})}),e.jsx(g,{md:12,children:e.jsxs(F,{label:"Description",children:[e.jsx(E,{name:"description",as:"textarea",className:`form-control ${s.description&&i.description?"is-invalid":""}`,placeholder:"Lesson description",rows:4,style:{minHeight:"120px"}}),e.jsx(N,{name:"description",component:_.Control.Feedback,type:"invalid"})]})}),e.jsx(g,{md:12,children:e.jsx(_.Check,{type:"switch",id:"isAvailableOnFree",label:"Available on Free",checked:t.is_available_on_free,onChange:c=>f("is_available_on_free",c.target.checked)})}),e.jsxs(g,{md:12,children:[e.jsx("label",{className:"form-label",children:"Lesson Batch"}),e.jsx(E,{name:"lesson_batch",component:K,localOptions:k,value:t.lesson_batch}),s.lesson_batch&&i.lesson_batch&&e.jsx(_.Control.Feedback,{type:"invalid",className:"d-block",children:i.lesson_batch})]}),r.error&&e.jsx("p",{className:"text-danger mt-2",children:r.error.message||"Submission failed."})]})}),e.jsxs(j.Footer,{children:[e.jsx(w,{variant:"secondary",onClick:C,children:"Cancel"}),e.jsx(w,{variant:"primary",type:"submit",disabled:x||r.loading,children:x||r.loading?e.jsxs(e.Fragment,{children:[e.jsx(W,{animation:"border",size:"sm",className:"me-2"}),"Saving..."]}):h?"Update":"Create"})]})]})})})}const P="/lms/lessons/lessons";function me(){const[d,C]=A(),m=U(),{showModal:l}=q();o.useEffect(()=>{d.get("batch_id")||m("/lessons/batches")},[d]);const r=o.useMemo(()=>`${P}/?batch_id=${d.get("batch_id")}`,[d]),n=L(`/lms/lessons/batches/${d.get("batch_id")}/`,{useInitial:!0,usePagination:!1}),a=L(r,{useInitial:!1,usePagination:!0}),h=S(),p=o.useMemo(()=>[{key:"id",label:"Id",sortable:!0},{key:"is_available_on_free",label:"Is available on free",render:s=>s.is_available_on_free?"true":"false"},{key:"title",label:"Title"}],[]),v=o.useCallback(s=>{a.fetchData(s)},[a.fetchData]),y=o.useCallback(()=>{l(B,{open:!0,record:{lesson_batch:n.data},onSuccess:()=>{a.fetchData()},onClose:()=>{}},{destroyOnClose:!0,hideOnClose:!0})},[l,n.data,a.fetchData]),D=o.useCallback(s=>{l(B,{open:!0,record:s,onSuccess:()=>{a.fetchData()}},{destroyOnClose:!0,hideOnClose:!0})},[a.fetchData]),k=o.useCallback(s=>{const i=l(X,{open:!0,title:"Delete Item",message:`Are you sure you want to delete "${s.title}"?`,loading:a.loading,onConfirm:async()=>{try{await h.mutate(`${P}/${s.id}/`,"DELETE"),b.success("Item deleted successfully!"),await a.fetchData(),i.hide()}catch{b.error("Failed to delete item.")}}},{destroyOnClose:!0,hideOnClose:!0})},[a.fetchData,h.mutate]),u=o.useCallback(s=>{const i=`/lessons/${s.id}/pages/edit-view`;m(i)},[m]);return e.jsx(I,{children:e.jsx(g,{sm:12,children:e.jsxs(z,{title:"Lessons",children:[e.jsxs("div",{className:"align-items-center m-l-0 row",children:[e.jsx("div",{className:"col-sm-6"}),e.jsx("div",{className:"text-end col-sm-6",children:e.jsxs("button",{type:"button",className:"btn-sm btn-round mb-3 btn btn-success",onClick:y,children:[e.jsx("i",{className:"feather icon-plus"})," Add"]})})]}),e.jsx(V,{columns:p,control:a,onEdit:D,onDelete:k,extraActions:s=>e.jsx(e.Fragment,{children:e.jsx(H.Item,{onClick:()=>u(s),children:"Pages View"})}),onFilterChange:v})]})})})}export{me as default};
